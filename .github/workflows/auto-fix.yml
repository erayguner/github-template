name: Auto Fix CI Failures

on:
  workflow_run:
    workflows: ["Basic CI"]   # must exactly match your CI workflow name
    types: [completed]

permissions:
  contents: write
  pull-requests: write
  actions: read
  id-token: write

jobs:
  auto-fix:
    # run only for failed PR runs; avoid loops on our own auto-fix branches
    if: |
      github.event.workflow_run.conclusion == 'failure' &&
      github.event.workflow_run.event == 'pull_request' &&
      !startsWith(github.event.workflow_run.head_branch, 'claude-auto-fix-ci-')
    runs-on: ubuntu-latest

    steps:
      - name: Verify Claude API key exists
        run: |
          if [ -z "${{ secrets.ANTHROPIC_API_KEY }}" ] && [ -z "${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}" ]; then
            echo "::error::Missing ANTHROPIC_API_KEY (or CLAUDE_CODE_OAUTH_TOKEN)."
            exit 1
          fi

      - name: Get PR details
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const run = context.payload.workflow_run;
            const prLite = run.pull_requests && run.pull_requests[0];
            if (!prLite) core.setFailed('No PR found on workflow_run payload.');
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner, repo: context.repo.repo, pull_number: prLite.number
            });
            const sameRepo = pr.head.repo.full_name === `${context.repo.owner}/${context.repo.repo}`;
            core.setOutput('number', pr.number.toString());
            core.setOutput('same_repo', sameRepo ? 'true' : 'false');
            core.setOutput('head_ref', pr.head.ref);
            core.setOutput('base_ref', pr.base.ref);

      - name: Checkout PR head
        uses: actions/checkout@v5
        with:
          ref: ${{ steps.pr.outputs.head_ref }}
          fetch-depth: 0
          persist-credentials: true
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup git identity
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name  "github-actions[bot]"

      - name: Decide fix branch
        id: branch
        run: |
          if [ "${{ steps.pr.outputs.same_repo }}" = "true" ]; then
            echo "branch=${{ steps.pr.outputs.head_ref }}" >> $GITHUB_OUTPUT
            echo "mode=direct" >> $GITHUB_OUTPUT
          else
            FIX_BRANCH="claude-auto-fix-ci-${{ steps.pr.outputs.head_ref }}-${{ github.run_id }}"
            git checkout -b "$FIX_BRANCH"
            echo "branch=$FIX_BRANCH" >> $GITHUB_OUTPUT
            echo "mode=branch" >> $GITHUB_OUTPUT
          fi

      - name: Collect failed job names
        id: details
        uses: actions/github-script@v7
        with:
          script: |
            const run_id = context.payload.workflow_run.id;
            const { data } = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner, repo: context.repo.repo, run_id
            });
            const failed = data.jobs.filter(j => j.conclusion === 'failure').map(j => j.name);
            core.setOutput('failed', JSON.stringify(failed));

      # --- Ask Claude to make edits in-place ---
      - name: Claude: attempt targeted CI fixes
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          prompt: |
            /fix-ci
            Repository: ${{ github.repository }}
            Base Branch: ${{ steps.pr.outputs.base_ref }}
            PR Branch: ${{ steps.pr.outputs.head_ref }}
            Failed Jobs: ${{ steps.details.outputs.failed }}
            Goal: Make minimal, correct edits to fix the failing CI checks.
            Constraints: Keep changes small; do not change workflow names/triggers unless required to pass.
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY != '' && secrets.ANTHROPIC_API_KEY || secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          # ensure editing is allowed (Claude writes inside workspace)
          claude_args: "--allowedTools 'Edit(**),MultiEdit(**),Write(**),Grep(**),LS(**)'"

      # --- Show what (if anything) changed ---
      - name: Show working tree diff (debug)
        if: always()
        run: |
          echo "Workspace: $GITHUB_WORKSPACE"
          git status --porcelain=v1
          git diff --name-only || true

      # --- Fallback auto-fix pass if Claude didn't edit files ---
      - name: Install quick-fix tools (ruff/terraform/yamllint)
        if: always()
        run: |
          sudo apt-get update && sudo apt-get install -y shellcheck
          python3 -m pip install --user ruff yamllint
          echo "TOOLS READY"

      - name: Run fallback formatters
        if: always()
        run: |
          # Python quick-fix (if any .py present)
          if git ls-files '*.py' | grep -q .; then
            ~/.local/bin/ruff check --fix . || true
            ~/.local/bin/ruff format . || true
          fi
          # YAML quick-fix (relaxed; non-blocking)
          if git ls-files '*.yml' '*.yaml' | grep -q .; then
            ~/.local/bin/yamllint -d "{extends: relaxed}" . || true
          fi
          # Terraform fmt (if present)
          if git ls-files '*.tf' | grep -q .; then
            terraform -version || true
            terraform fmt -recursive || true
          fi

      - name: Commit and push changes (if any)
        run: |
          git add -A
          if git diff --staged --quiet; then
            echo "No changes to commit."; exit 0
          fi
          git commit -m "chore(ci): auto-fix CI failures"
          git push -u origin "${{ steps.branch.outputs.branch }}"

      - name: Comment (direct push case)
        if: steps.branch.outputs.mode == 'direct'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: Number('${{ steps.pr.outputs.number }}'),
              body: "ðŸ¤– Auto-fixes pushed directly to `${{ steps.pr.outputs.head_ref }}`; CI will re-run."
            });

      - name: Open PR for fixes (fork case)
        if: steps.branch.outputs.mode == 'branch'
        uses: actions/github-script@v7
        with:
          script: |
            const head = "${{ steps.branch.outputs.branch }}";
            const base = "${{ steps.pr.outputs.base_ref }}";
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner, repo: context.repo.repo, state: 'open',
              head: `${context.repo.owner}:${head}`
            });
            if (!prs.length) {
              const { data: pr } = await github.rest.pulls.create({
                owner: context.repo.owner, repo: context.repo.repo,
                title: "chore(ci): auto-fix CI failures", head, base,
                body: "Automated fixes for failing CI."
              });
              core.info(`Opened PR: ${pr.html_url}`);
            }

      - name: Leave note on original PR (fork case)
        if: steps.branch.outputs.mode == 'branch'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner, repo: context.repo.repo,
              issue_number: Number('${{ steps.pr.outputs.number }}'),
              body: "ðŸ¤– Pushed auto-fix branch `${{ steps.branch.outputs.branch }}` and opened a PR toward `${{ steps.pr.outputs.base_ref }}`."
            })
