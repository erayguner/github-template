name: Claude Auto-Fix

on:
  # Trigger on push to any branch
  workflow_run:
    workflows: ["Basic CI"]        # TODO: Update this to match your CI workflow name exactly
    types: [completed]
  # Trigger on pull requests
  pull_request:
    branches: [main, master, develop]
  # Manual trigger
  workflow_dispatch:
    inputs:
      force_run:
        description: 'Force run even if no issues detected'
        required: false
        default: false
        type: boolean
      target_branch:
        description: 'Target branch for fixes (defaults to current branch)'
        required: false
        type: string

# Required permissions for the workflow
permissions:
  contents: write
  pull-requests: write
  issues: read
  checks: read
  actions: read
  security-events: read

jobs:
  detect-issues:
    name: Detect Issues & Auto-Fix
    runs-on: ubuntu-latest
    
    # Skip on auto-fix commits to prevent loops
    if: "!contains(github.event.head_commit.message, '[auto-fix]')"
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
        if: hashFiles('package.json') != ''

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
        if: hashFiles('requirements.txt', 'pyproject.toml', '*.py') != ''

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'
        if: hashFiles('go.mod', '*.go') != ''

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
        if: hashFiles('Cargo.toml', '*.rs') != ''

      - name: Install dependencies
        run: |
          # Install Node.js dependencies
          if [ -f "package.json" ]; then
            npm ci || npm install
          fi
          
          # Install Python dependencies
          if [ -f "requirements.txt" ]; then
            pip install -r requirements.txt
          elif [ -f "pyproject.toml" ]; then
            pip install -e .
          fi
          
          # Install Go dependencies
          if [ -f "go.mod" ]; then
            go mod download
          fi
          
          # Install Rust dependencies
          if [ -f "Cargo.toml" ]; then
            cargo fetch
          fi

      - name: Run linters and collect issues
        id: lint
        continue-on-error: true
        run: |
          echo "## ðŸ” Detecting Issues" >> $GITHUB_STEP_SUMMARY
          
          ISSUES_FOUND=false
          
          # JavaScript/TypeScript linting
          if [ -f "package.json" ]; then
            echo "### JavaScript/TypeScript Issues" >> $GITHUB_STEP_SUMMARY
            
            # ESLint
            if npm list eslint &>/dev/null; then
              echo "Running ESLint..." >> $GITHUB_STEP_SUMMARY
              if npx eslint . --format json --output-file eslint-report.json 2>/dev/null || true; then
                if [ -f "eslint-report.json" ] && [ "$(cat eslint-report.json)" != "[]" ]; then
                  ISSUES_FOUND=true
                  echo "- âŒ ESLint issues detected" >> $GITHUB_STEP_SUMMARY
                else
                  echo "- âœ… No ESLint issues" >> $GITHUB_STEP_SUMMARY
                fi
              fi
            fi
            
            # TypeScript compiler
            if npm list typescript &>/dev/null; then
              echo "Running TypeScript check..." >> $GITHUB_STEP_SUMMARY
              if ! npx tsc --noEmit 2>tsc-errors.txt; then
                ISSUES_FOUND=true
                echo "- âŒ TypeScript compilation errors detected" >> $GITHUB_STEP_SUMMARY
              else
                echo "- âœ… No TypeScript errors" >> $GITHUB_STEP_SUMMARY
              fi
            fi
            
            # Prettier
            if npm list prettier &>/dev/null; then
              echo "Checking Prettier formatting..." >> $GITHUB_STEP_SUMMARY
              if ! npx prettier --check . 2>/dev/null; then
                ISSUES_FOUND=true
                echo "- âŒ Code formatting issues detected" >> $GITHUB_STEP_SUMMARY
              else
                echo "- âœ… Code is properly formatted" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          fi
          
          # Python linting
          if compgen -G "*.py" > /dev/null; then
            echo "### Python Issues" >> $GITHUB_STEP_SUMMARY
            
            # Install Python linting tools
            pip install -q flake8 black isort mypy pylint bandit safety || true
            
            # Flake8
            if command -v flake8 &>/dev/null; then
              echo "Running Flake8..." >> $GITHUB_STEP_SUMMARY
              if ! flake8 . --output-file=flake8-report.txt 2>/dev/null; then
                ISSUES_FOUND=true
                echo "- âŒ Flake8 issues detected" >> $GITHUB_STEP_SUMMARY
              else
                echo "- âœ… No Flake8 issues" >> $GITHUB_STEP_SUMMARY
              fi
            fi
            
            # Black formatting
            if command -v black &>/dev/null; then
              echo "Checking Black formatting..." >> $GITHUB_STEP_SUMMARY
              if ! black --check . 2>/dev/null; then
                ISSUES_FOUND=true
                echo "- âŒ Black formatting issues detected" >> $GITHUB_STEP_SUMMARY
              else
                echo "- âœ… Code is properly formatted (Black)" >> $GITHUB_STEP_SUMMARY
              fi
            fi
            
            # Security check with Bandit
            if command -v bandit &>/dev/null; then
              echo "Running Bandit security check..." >> $GITHUB_STEP_SUMMARY
              if ! bandit -r . -f json -o bandit-report.json 2>/dev/null; then
                ISSUES_FOUND=true
                echo "- âŒ Security issues detected" >> $GITHUB_STEP_SUMMARY
              else
                echo "- âœ… No security issues found" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          fi
          
          # Go linting
          if [ -f "go.mod" ]; then
            echo "### Go Issues" >> $GITHUB_STEP_SUMMARY
            
            # Go fmt
            if [ -n "$(gofmt -l .)" ]; then
              ISSUES_FOUND=true
              echo "- âŒ Go formatting issues detected" >> $GITHUB_STEP_SUMMARY
            else
              echo "- âœ… Go code is properly formatted" >> $GITHUB_STEP_SUMMARY
            fi
            
            # Go vet
            if ! go vet ./... 2>go-vet-errors.txt; then
              ISSUES_FOUND=true
              echo "- âŒ Go vet issues detected" >> $GITHUB_STEP_SUMMARY
            else
              echo "- âœ… No Go vet issues" >> $GITHUB_STEP_SUMMARY
            fi
            
            # Staticcheck
            go install honnef.co/go/tools/cmd/staticcheck@latest
            if ! staticcheck ./... 2>staticcheck-errors.txt; then
              ISSUES_FOUND=true
              echo "- âŒ Staticcheck issues detected" >> $GITHUB_STEP_SUMMARY
            else
              echo "- âœ… No staticcheck issues" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          # Rust linting
          if [ -f "Cargo.toml" ]; then
            echo "### Rust Issues" >> $GITHUB_STEP_SUMMARY
            
            # Cargo fmt
            if ! cargo fmt -- --check 2>/dev/null; then
              ISSUES_FOUND=true
              echo "- âŒ Rust formatting issues detected" >> $GITHUB_STEP_SUMMARY
            else
              echo "- âœ… Rust code is properly formatted" >> $GITHUB_STEP_SUMMARY
            fi
            
            # Cargo clippy
            if ! cargo clippy -- -D warnings 2>clippy-errors.txt; then
              ISSUES_FOUND=true
              echo "- âŒ Clippy issues detected" >> $GITHUB_STEP_SUMMARY
            else
              echo "- âœ… No Clippy issues" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          echo "issues_found=$ISSUES_FOUND" >> $GITHUB_OUTPUT

      - name: Run tests
        id: tests
        continue-on-error: true
        run: |
          echo "## ðŸ§ª Running Tests" >> $GITHUB_STEP_SUMMARY
          
          TEST_FAILURES=false
          
          # Node.js tests
          if [ -f "package.json" ]; then
            if npm run test --if-present 2>test-errors.txt; then
              echo "- âœ… Node.js tests passed" >> $GITHUB_STEP_SUMMARY
            else
              TEST_FAILURES=true
              echo "- âŒ Node.js tests failed" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          # Python tests
          if compgen -G "test_*.py" > /dev/null || compgen -G "*_test.py" > /dev/null; then
            pip install -q pytest || true
            if command -v pytest &>/dev/null; then
              if pytest 2>pytest-errors.txt; then
                echo "- âœ… Python tests passed" >> $GITHUB_STEP_SUMMARY
              else
                TEST_FAILURES=true
                echo "- âŒ Python tests failed" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          fi
          
          # Go tests
          if [ -f "go.mod" ]; then
            if go test ./... 2>go-test-errors.txt; then
              echo "- âœ… Go tests passed" >> $GITHUB_STEP_SUMMARY
            else
              TEST_FAILURES=true
              echo "- âŒ Go tests failed" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          # Rust tests
          if [ -f "Cargo.toml" ]; then
            if cargo test 2>rust-test-errors.txt; then
              echo "- âœ… Rust tests passed" >> $GITHUB_STEP_SUMMARY
            else
              TEST_FAILURES=true
              echo "- âŒ Rust tests failed" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          echo "test_failures=$TEST_FAILURES" >> $GITHUB_OUTPUT

      - name: Create issue reports
        if: steps.lint.outputs.issues_found == 'true' || steps.tests.outputs.test_failures == 'true'
        run: |
          mkdir -p .claude/reports
          
          # Collect all issues into a comprehensive report
          cat > .claude/reports/issues.md << 'EOF'
          # ðŸš¨ Auto-Detected Issues Report
          
          Generated on: $(date)
          Branch: ${{ github.ref_name }}
          Commit: ${{ github.sha }}
          
          ## Summary
          - Issues Found: ${{ steps.lint.outputs.issues_found }}
          - Test Failures: ${{ steps.tests.outputs.test_failures }}
          
          ## Detailed Issues
          EOF
          
          # Add linting issues
          if [ -f "eslint-report.json" ]; then
            echo -e "\n### ESLint Issues\n\`\`\`json" >> .claude/reports/issues.md
            cat eslint-report.json >> .claude/reports/issues.md
            echo -e "\`\`\`" >> .claude/reports/issues.md
          fi
          
          if [ -f "flake8-report.txt" ]; then
            echo -e "\n### Flake8 Issues\n\`\`\`" >> .claude/reports/issues.md
            cat flake8-report.txt >> .claude/reports/issues.md
            echo -e "\`\`\`" >> .claude/reports/issues.md
          fi
          
          # Add test failures
          if [ -f "test-errors.txt" ]; then
            echo -e "\n### Test Failures\n\`\`\`" >> .claude/reports/issues.md
            cat test-errors.txt >> .claude/reports/issues.md
            echo -e "\`\`\`" >> .claude/reports/issues.md
          fi

      - name: Auto-fix with Claude
        if: (steps.lint.outputs.issues_found == 'true' || steps.tests.outputs.test_failures == 'true' || github.event.inputs.force_run == 'true') && secrets.ANTHROPIC_API_KEY != ''
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "## ðŸ¤– Auto-Fixing with Claude" >> $GITHUB_STEP_SUMMARY
          
          # Use Python with Anthropic SDK for more reliable Claude integration
          cat > claude_fixer.py << 'EOF'
          import os
          import sys
          import subprocess
          import json
          from anthropic import Anthropic

          def main():
              api_key = os.environ.get('ANTHROPIC_API_KEY')
              if not api_key:
                  print("âŒ ANTHROPIC_API_KEY not found")
                  return False

              try:
                  client = Anthropic(api_key=api_key)
                  
                  # Collect repository information
                  repo_files = []
                  for ext in ['*.py', '*.js', '*.ts', '*.go', '*.rs']:
                      result = subprocess.run(['find', '.', '-name', ext], capture_output=True, text=True)
                      repo_files.extend(result.stdout.strip().split('\n') if result.stdout.strip() else [])
                  
                  # Read issue reports
                  issues_content = ""
                  if os.path.exists('.claude/reports/issues.md'):
                      with open('.claude/reports/issues.md', 'r') as f:
                          issues_content = f.read()
                  
                  # Create comprehensive fix prompt
                  prompt = f"""You are an expert code reviewer and auto-fixer. Please analyze this repository and fix all detected issues:

          ## Task
          Fix all issues in this repository while maintaining functionality:
          1. **Linting Issues**: Resolve all linter warnings/errors
          2. **Formatting**: Apply consistent code formatting
          3. **Test Failures**: Fix failing tests
          4. **Security**: Address vulnerabilities
          5. **Type Errors**: Resolve compilation issues

          ## Repository Files ({len([f for f in repo_files if f])})
          {chr(10).join(f for f in repo_files[:20] if f)}

          ## Detected Issues
          {issues_content or 'See CI output for specific issues detected by linters and tests.'}

          ## Instructions
          - Make targeted fixes that resolve specific issues
          - Maintain original functionality
          - Follow existing code style and patterns
          - Ensure all tests pass after fixes
          - Output a summary of changes made

          Please provide specific fixes for each detected issue."""

                  # Request fixes from Claude
                  response = client.messages.create(
                      model="claude-3-5-sonnet-20241022",
                      max_tokens=4000,
                      messages=[{"role": "user", "content": prompt}]
                  )
                  
                  with open('claude-fixes.txt', 'w') as f:
                      f.write(response.content[0].text)
                  
                  print("âœ… Claude analysis completed")
                  print("Fixes saved to: claude-fixes.txt")
                  return True
                  
              except Exception as e:
                  print(f"âŒ Claude integration error: {e}")
                  return False

          if __name__ == "__main__":
              success = main()
              sys.exit(0 if success else 1)
          EOF
          
          # Install anthropic SDK and run Claude fixer
          pip install anthropic
          echo "Invoking Claude for intelligent auto-fixes..." >> $GITHUB_STEP_SUMMARY
          if python claude_fixer.py; then
            echo "- âœ… Claude analysis completed" >> $GITHUB_STEP_SUMMARY
            if [ -f "claude-fixes.txt" ]; then
              echo "- ðŸ“‹ Fix recommendations generated" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "- âŒ Claude integration failed" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Apply formatting fixes
        if: steps.lint.outputs.issues_found == 'true'
        run: |
          echo "## ðŸŽ¨ Applying Formatting Fixes" >> $GITHUB_STEP_SUMMARY
          
          # JavaScript/TypeScript formatting
          if [ -f "package.json" ] && npm list prettier &>/dev/null; then
            npx prettier --write . || true
            echo "- âœ… Applied Prettier formatting" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Python formatting
          if compgen -G "*.py" > /dev/null; then
            if command -v black &>/dev/null; then
              black . || true
              echo "- âœ… Applied Black formatting" >> $GITHUB_STEP_SUMMARY
            fi
            
            if command -v isort &>/dev/null; then
              isort . || true
              echo "- âœ… Applied import sorting" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          # Go formatting
          if [ -f "go.mod" ]; then
            gofmt -w . || true
            echo "- âœ… Applied Go formatting" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Rust formatting
          if [ -f "Cargo.toml" ]; then
            cargo fmt || true
            echo "- âœ… Applied Rust formatting" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Commit and push fixes
        if: steps.lint.outputs.issues_found == 'true' || steps.tests.outputs.test_failures == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Configure git
          git config --local user.email "action@github.com"
          git config --local user.name "Claude Auto-Fix Bot"
          
          # Check for changes
          if [ -n "$(git status --porcelain)" ]; then
            echo "## ðŸ’¾ Committing Fixes" >> $GITHUB_STEP_SUMMARY
            
            # Add changed files
            git add -A
            
            # Create detailed commit message
            COMMIT_MSG="[auto-fix] Resolve issues detected by CI

            ðŸ¤– Generated with Claude Code
            
            Fixes applied:
            - Linting issues resolved
            - Code formatting applied
            - Test failures addressed
            
            Branch: ${{ github.ref_name }}
            Workflow: ${{ github.workflow }}
            Run: ${{ github.run_number }}"
            
            git commit -m "$COMMIT_MSG" || exit 0
            
            # Push changes
            TARGET_BRANCH="${{ github.event.inputs.target_branch || github.ref_name }}"
            git push origin HEAD:$TARGET_BRANCH
            
            echo "- âœ… Changes committed and pushed to $TARGET_BRANCH" >> $GITHUB_STEP_SUMMARY
          else
            echo "- â„¹ï¸ No changes to commit" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Create Pull Request (for main/master branches)
        if: (github.ref_name == 'main' || github.ref_name == 'master') && steps.lint.outputs.issues_found == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Create a fix branch
          FIX_BRANCH="auto-fix/$(date +%Y%m%d-%H%M%S)"
          git checkout -b $FIX_BRANCH
          
          # Push fix branch
          git push origin $FIX_BRANCH
          
          # Create PR using GitHub CLI
          gh pr create \
            --title "ðŸ¤– [Auto-Fix] Resolve detected issues" \
            --body "This PR contains automated fixes generated by Claude Code.
            
            ## Changes
            - Resolved linting issues
            - Applied code formatting
            - Fixed test failures
            
            ## Review Notes
            These changes were automatically generated. Please review before merging.
            
            Generated by: ${{ github.workflow }} #${{ github.run_number }}" \
            --head $FIX_BRANCH \
            --base ${{ github.ref_name }}

      - name: Upload reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: auto-fix-reports
          path: |
            .claude/reports/
            *-report.*
            *-errors.txt
          retention-days: 7

      - name: Summary
        if: always()
        run: |
          echo "## ðŸ“Š Auto-Fix Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow**: ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Issues Found**: ${{ steps.lint.outputs.issues_found || 'unknown' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Test Failures**: ${{ steps.tests.outputs.test_failures || 'unknown' }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ secrets.ANTHROPIC_API_KEY }}" != "" ]; then
            echo "- **Claude Integration**: âœ… Enabled" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Claude Integration**: âŒ Missing ANTHROPIC_API_KEY" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "- **Runtime**: $(date)" >> $GITHUB_STEP_SUMMARY