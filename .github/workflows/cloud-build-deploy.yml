# Cloud Build Deployment Workflow
# Triggers Google Cloud Build on successful CI completion
#
# Prerequisites:
# 1. Set up Workload Identity Federation (see docs/GCP-SETUP.md)
# 2. Configure GitHub secrets:
#    - GCP_PROJECT_ID: Your GCP project ID
#    - GCP_WORKLOAD_IDENTITY_PROVIDER: Workload Identity Provider resource name
#    - GCP_SERVICE_ACCOUNT: Service account email for Cloud Build

name: Deploy to GCP

on:
  # Trigger on successful CI pipeline completion
  workflow_run:
    workflows: ["CI/CD Pipeline"]
    types: [completed]
    branches: [main]

  # Manual trigger with environment selection
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment"
        required: true
        default: "dev"
        type: choice
        options:
          - dev
          - staging
          - prod
      skip_tests:
        description: "Skip test stages"
        required: false
        default: false
        type: boolean

# Prevent concurrent deployments to same environment
concurrency:
  group: deploy-${{ github.event.inputs.environment || 'dev' }}
  cancel-in-progress: false

env:
  GCP_REGION: us-central1
  TERRAFORM_VERSION: 1.10.0

permissions:
  contents: read
  id-token: write  # Required for Workload Identity Federation
  actions: read

jobs:
  # ============================================================================
  # Pre-deployment Checks
  # ============================================================================
  pre-deploy-check:
    name: Pre-deployment Validation
    runs-on: ubuntu-latest

    # Only run if CI passed (for workflow_run trigger)
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')

    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      should_deploy: ${{ steps.check.outputs.should_deploy }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set environment
        id: set-env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "environment=${{ github.event.inputs.environment }}" >> "$GITHUB_OUTPUT"
          else
            echo "environment=dev" >> "$GITHUB_OUTPUT"
          fi

      - name: Check deployment conditions
        id: check
        run: |
          ENV="${{ steps.set-env.outputs.environment }}"

          # Production requires explicit approval
          if [ "${ENV}" == "prod" ]; then
            echo "::warning::Production deployment requires manual approval"
            echo "should_deploy=false" >> "$GITHUB_OUTPUT"
          else
            echo "should_deploy=true" >> "$GITHUB_OUTPUT"
          fi

  # ============================================================================
  # Authenticate to Google Cloud
  # ============================================================================
  authenticate:
    name: Authenticate to GCP
    runs-on: ubuntu-latest
    needs: pre-deploy-check
    if: needs.pre-deploy-check.outputs.should_deploy == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      # Authenticate using Workload Identity Federation (recommended)
      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Verify authentication
        run: |
          echo "::notice::Successfully authenticated to GCP"
          gcloud config list

  # ============================================================================
  # Trigger Cloud Build
  # ============================================================================
  cloud-build:
    name: Trigger Cloud Build
    runs-on: ubuntu-latest
    needs: [pre-deploy-check, authenticate]
    environment: ${{ needs.pre-deploy-check.outputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Submit Cloud Build
        id: build
        run: |
          ENV="${{ needs.pre-deploy-check.outputs.environment }}"
          echo "::notice::Starting Cloud Build for environment: ${ENV}"

          # Submit build to Cloud Build
          BUILD_ID=$(gcloud builds submit \
            --config=cloudbuild.yaml \
            --substitutions="_ENVIRONMENT=${ENV},_REGION=${{ env.GCP_REGION }}" \
            --async \
            --format='value(id)' \
            .)

          echo "build_id=${BUILD_ID}" >> "$GITHUB_OUTPUT"
          echo "::notice::Cloud Build started: ${BUILD_ID}"

          # Stream build logs
          gcloud builds log "${BUILD_ID}" --stream || true

      - name: Wait for build completion
        run: |
          BUILD_ID="${{ steps.build.outputs.build_id }}"

          echo "Waiting for build ${BUILD_ID} to complete..."
          gcloud builds describe "${BUILD_ID}" --format='value(status)'

          # Poll for completion (max 30 minutes)
          for _ in {1..60}; do
            STATUS=$(gcloud builds describe "${BUILD_ID}" --format='value(status)')
            echo "Build status: ${STATUS}"

            if [ "${STATUS}" == "SUCCESS" ]; then
              echo "::notice::Build completed successfully!"
              exit 0
            elif [ "${STATUS}" == "FAILURE" ] || [ "${STATUS}" == "CANCELLED" ] || [ "${STATUS}" == "TIMEOUT" ]; then
              echo "::error::Build failed with status: ${STATUS}"
              gcloud builds log "${BUILD_ID}" || true
              exit 1
            fi

            sleep 30
          done

          echo "::error::Build timed out"
          exit 1

  # ============================================================================
  # Post-deployment Validation
  # ============================================================================
  validate-deployment:
    name: Validate Deployment
    runs-on: ubuntu-latest
    needs: [pre-deploy-check, cloud-build]
    if: success()

    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Validate infrastructure
        run: |
          ENV="${{ needs.pre-deploy-check.outputs.environment }}"
          echo "::notice::Validating deployment for environment: $ENV"

          # Check Cloud Run service (if deployed)
          SERVICE_NAME="app-$ENV"
          SERVICE_URL=$(gcloud run services describe $SERVICE_NAME \
            --region=${{ env.GCP_REGION }} \
            --format='value(status.url)' 2>/dev/null || echo "")

          if [ -n "$SERVICE_URL" ]; then
            echo "::notice::Cloud Run service URL: $SERVICE_URL"

            # Health check
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$SERVICE_URL" || echo "000")
            if [ "$HTTP_CODE" == "200" ] || [ "$HTTP_CODE" == "401" ] || [ "$HTTP_CODE" == "403" ]; then
              echo "::notice::Health check passed (HTTP $HTTP_CODE)"
            else
              echo "::warning::Health check returned HTTP $HTTP_CODE"
            fi
          else
            echo "::notice::No Cloud Run service found (infrastructure-only deployment)"
          fi

      - name: Deployment summary
        run: |
          echo "=============================================="
          echo "       DEPLOYMENT SUMMARY                     "
          echo "=============================================="
          echo "Environment:  ${{ needs.pre-deploy-check.outputs.environment }}"
          echo "Region:       ${{ env.GCP_REGION }}"
          echo "Commit SHA:   ${{ github.sha }}"
          echo "Triggered by: ${{ github.actor }}"
          echo "=============================================="

  # ============================================================================
  # Production Deployment (requires approval)
  # ============================================================================
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: pre-deploy-check
    if: >
      github.event_name == 'workflow_dispatch' &&
      github.event.inputs.environment == 'prod'
    environment:
      name: production
      url: https://console.cloud.google.com/run

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Deploy to Production
        run: |
          echo "::notice::Starting production deployment..."

          gcloud builds submit \
            --config=cloudbuild.yaml \
            --substitutions="_ENVIRONMENT=prod,_REGION=${{ env.GCP_REGION }}" \
            --timeout=1800s

          echo "::notice::Production deployment completed!"

      - name: Notify on success
        if: success()
        run: |
          echo "::notice::Production deployment successful!"
          # Add Slack/Teams notification here if needed
