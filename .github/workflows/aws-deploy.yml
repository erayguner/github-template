name: AWS Deployment

on:
  push:
    branches:
      - main
      - develop
      - 'release/**'
    paths:
      - 'terraform/aws/**'
      - 'python/**'
      - '.github/workflows/aws-deploy.yml'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'terraform/aws/**'
      - 'python/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
      action:
        description: 'Deployment action'
        required: true
        type: choice
        options:
          - deploy
          - destroy
          - plan-only

permissions:
  contents: read
  id-token: write  # Required for OIDC authentication with AWS
  security-events: write
  pull-requests: write

env:
  TERRAFORM_VERSION: '1.6.0'
  AWS_REGION: 'eu-west-2'  # Default region (standardised)

jobs:
  # ============================================================================
  # Security Scanning and Validation
  # ============================================================================
  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Format Check
        working-directory: ./terraform/aws
        run: terraform fmt -check -diff -recursive .

      - name: Terraform Security Scan (tfsec)
        uses: aquasecurity/tfsec-action@v1.0.3
        with:
          working_directory: ./terraform/aws
          format: sarif
          output: tfsec.sarif
          soft_fail: false

      - name: Upload tfsec SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: tfsec.sarif
          category: terraform-aws-security

      - name: Checkov Security Scan
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: terraform/aws
          framework: terraform
          output_format: sarif
          output_file_path: checkov.sarif
          soft_fail: false

      - name: Upload Checkov SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: checkov.sarif
          category: terraform-aws-checkov

      - name: Secret Scanning
        uses: trufflesecurity/trufflehog@v3.85.0
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --only-verified

  # ============================================================================
  # Determine Deployment Environment
  # ============================================================================
  determine-environment:
    name: Determine Environment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      aws-region: ${{ steps.set-env.outputs.aws-region }}
      should-deploy: ${{ steps.set-env.outputs.should-deploy }}
    steps:
      - name: Set environment
        id: set-env
        run: |
          # Determine environment based on branch or manual input
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            ENV="${{ github.event.inputs.environment }}"
            DEPLOY="true"
            if [[ "${{ github.event.inputs.action }}" == "plan-only" ]]; then
              DEPLOY="false"
            fi
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            ENV="prod"
            DEPLOY="true"
          elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
            ENV="staging"
            DEPLOY="true"
          elif [[ "${{ github.ref }}" == refs/heads/release/* ]]; then
            ENV="staging"
            DEPLOY="true"
          else
            ENV="dev"
            DEPLOY="false"  # Only plan for PRs
          fi

          # Set AWS region based on environment
          case $ENV in
            prod)
              REGION="eu-west-2"
              ;;
            staging)
              REGION="eu-west-2"
              ;;
            dev)
              REGION="eu-west-2"
              ;;
            *)
              REGION="eu-west-2"
              ;;
          esac

          echo "environment=${ENV}" >> $GITHUB_OUTPUT
          echo "aws-region=${REGION}" >> $GITHUB_OUTPUT
          echo "should-deploy=${DEPLOY}" >> $GITHUB_OUTPUT

          echo "ðŸ“ Environment: ${ENV}"
          echo "ðŸŒ AWS Region: ${REGION}"
          echo "ðŸš€ Should Deploy: ${DEPLOY}"

  # ============================================================================
  # Terraform Plan
  # ============================================================================
  terraform-plan:
    name: Terraform Plan (${{ needs.determine-environment.outputs.environment }})
    runs-on: ubuntu-latest
    needs: [security-scan, determine-environment]
    environment:
      name: ${{ needs.determine-environment.outputs.environment }}
    outputs:
      plan-exitcode: ${{ steps.plan.outputs.exitcode }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets[format('AWS_ROLE_ARN_{0}', needs.determine-environment.outputs.environment)] }}
          aws-region: ${{ needs.determine-environment.outputs.aws-region }}
          role-session-name: github-actions-terraform-plan

      - name: Terraform Init
        working-directory: ./terraform/aws
        run: |
          terraform init \
            -backend-config="bucket=${{ secrets[format('AWS_TFSTATE_BUCKET_{0}', needs.determine-environment.outputs.environment)] }}" \
            -backend-config="key=${{ needs.determine-environment.outputs.environment }}/terraform.tfstate" \
            -backend-config="region=${{ needs.determine-environment.outputs.aws-region }}" \
            -backend-config="encrypt=true" \
            -backend-config="dynamodb_table=${{ secrets[format('AWS_TFSTATE_LOCK_TABLE_{0}', needs.determine-environment.outputs.environment)] }}"

      - name: Terraform Validate
        working-directory: ./terraform/aws
        run: terraform validate -no-color

      - name: Terraform Plan
        id: plan
        working-directory: ./terraform/aws
        run: |
          terraform plan \
            -var-file="environments/${{ needs.determine-environment.outputs.environment }}.tfvars" \
            -var="aws_region=${{ needs.determine-environment.outputs.aws-region }}" \
            -out=tfplan \
            -detailed-exitcode \
            -no-color
        continue-on-error: true

      - name: Save Plan Artifact
        if: steps.plan.outputs.exitcode == 2
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-${{ needs.determine-environment.outputs.environment }}
          path: terraform/aws/tfplan
          retention-days: 5

      - name: Comment PR with Plan
        if: github.event_name == 'pull_request' && steps.plan.outputs.exitcode == 2
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const plan = fs.readFileSync('terraform/aws/tfplan', 'utf8');
            const output = `#### Terraform Plan (AWS - ${{ needs.determine-environment.outputs.environment }})

            \`\`\`diff
            ${plan}
            \`\`\`

            **Environment**: ${{ needs.determine-environment.outputs.environment }}
            **Region**: ${{ needs.determine-environment.outputs.aws-region }}
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });

  # ============================================================================
  # Terraform Apply
  # ============================================================================
  terraform-apply:
    name: Terraform Apply (${{ needs.determine-environment.outputs.environment }})
    runs-on: ubuntu-latest
    needs: [terraform-plan, determine-environment]
    if: needs.determine-environment.outputs.should-deploy == 'true' && needs.terraform-plan.outputs.plan-exitcode == '2'
    environment:
      name: ${{ needs.determine-environment.outputs.environment }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets[format('AWS_ROLE_ARN_{0}', needs.determine-environment.outputs.environment)] }}
          aws-region: ${{ needs.determine-environment.outputs.aws-region }}
          role-session-name: github-actions-terraform-apply

      - name: Terraform Init
        working-directory: ./terraform/aws
        run: |
          terraform init \
            -backend-config="bucket=${{ secrets[format('AWS_TFSTATE_BUCKET_{0}', needs.determine-environment.outputs.environment)] }}" \
            -backend-config="key=${{ needs.determine-environment.outputs.environment }}/terraform.tfstate" \
            -backend-config="region=${{ needs.determine-environment.outputs.aws-region }}" \
            -backend-config="encrypt=true" \
            -backend-config="dynamodb_table=${{ secrets[format('AWS_TFSTATE_LOCK_TABLE_{0}', needs.determine-environment.outputs.environment)] }}"

      - name: Download Plan Artifact
        uses: actions/download-artifact@v4
        with:
          name: tfplan-${{ needs.determine-environment.outputs.environment }}
          path: terraform/aws/

      - name: Terraform Apply
        working-directory: ./terraform/aws
        run: terraform apply -auto-approve tfplan

      - name: Terraform Output
        id: output
        working-directory: ./terraform/aws
        run: |
          terraform output -json > outputs.json
          cat outputs.json

      - name: Save Outputs
        uses: actions/upload-artifact@v4
        with:
          name: terraform-outputs-${{ needs.determine-environment.outputs.environment }}
          path: terraform/aws/outputs.json
          retention-days: 30

  # ============================================================================
  # Application Deployment
  # ============================================================================
  deploy-application:
    name: Deploy Application
    runs-on: ubuntu-latest
    needs: [terraform-apply, determine-environment]
    if: needs.determine-environment.outputs.should-deploy == 'true'
    environment:
      name: ${{ needs.determine-environment.outputs.environment }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets[format('AWS_ROLE_ARN_{0}', needs.determine-environment.outputs.environment)] }}
          aws-region: ${{ needs.determine-environment.outputs.aws-region }}
          role-session-name: github-actions-app-deploy

      - name: Setup Python
        if: hashFiles('python/**/*.py') != ''
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        if: hashFiles('python/**/*.py') != ''
        uses: astral-sh/setup-uv@v6
        with:
          version: latest

      - name: Build Python Application
        if: hashFiles('python/**/*.py') != ''
        working-directory: ./python
        run: |
          uv venv
          uv sync
          uv build

      - name: Deploy to Lambda (if applicable)
        if: hashFiles('python/**/*.py') != ''
        run: |
          # Example: Deploy Python Lambda functions
          echo "Deploying Lambda functions..."
          # aws lambda update-function-code ...

      - name: Deploy to ECS (if applicable)
        run: |
          # Example: Update ECS service
          echo "Deploying to ECS..."
          # aws ecs update-service ...

      - name: Verify Deployment
        run: |
          echo "Verifying deployment health..."
          # Add health check commands here

  # ============================================================================
  # Post-Deployment Validation
  # ============================================================================
  post-deployment-validation:
    name: Post-Deployment Validation
    runs-on: ubuntu-latest
    needs: [deploy-application, determine-environment]
    if: needs.determine-environment.outputs.should-deploy == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets[format('AWS_ROLE_ARN_{0}', needs.determine-environment.outputs.environment)] }}
          aws-region: ${{ needs.determine-environment.outputs.aws-region }}
          role-session-name: github-actions-validation

      - name: Health Check
        run: |
          echo "Performing health checks..."
          # aws elbv2 describe-target-health ...

      - name: Smoke Tests
        run: |
          echo "Running smoke tests..."
          # Run basic API/endpoint tests

      - name: Monitoring Check
        run: |
          echo "Verifying monitoring setup..."
          # Check CloudWatch alarms, metrics

  # ============================================================================
  # Rollback Job (Manual Trigger)
  # ============================================================================
  rollback:
    name: Rollback Deployment
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'destroy' || failure()
    needs: [determine-environment]
    environment:
      name: ${{ needs.determine-environment.outputs.environment }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets[format('AWS_ROLE_ARN_{0}', needs.determine-environment.outputs.environment)] }}
          aws-region: ${{ needs.determine-environment.outputs.aws-region }}
          role-session-name: github-actions-rollback

      - name: Terraform Init
        working-directory: ./terraform/aws
        run: |
          terraform init \
            -backend-config="bucket=${{ secrets[format('AWS_TFSTATE_BUCKET_{0}', needs.determine-environment.outputs.environment)] }}" \
            -backend-config="key=${{ needs.determine-environment.outputs.environment }}/terraform.tfstate" \
            -backend-config="region=${{ needs.determine-environment.outputs.aws-region }}"

      - name: Revert to Previous State
        working-directory: ./terraform/aws
        run: |
          echo "Initiating rollback..."
          # terraform state pull > current.tfstate
          # Implement your rollback strategy here

  # ============================================================================
  # Notifications
  # ============================================================================
  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [deploy-application, post-deployment-validation, determine-environment]
    if: always()
    steps:
      - name: Deployment Status
        run: |
          if [[ "${{ needs.post-deployment-validation.result }}" == "success" ]]; then
            STATUS="âœ… Deployment Successful"
            COLOR="good"
          else
            STATUS="âŒ Deployment Failed"
            COLOR="danger"
          fi

          echo "STATUS=${STATUS}" >> $GITHUB_ENV
          echo "COLOR=${COLOR}" >> $GITHUB_ENV

      - name: Slack Notification (Optional)
        if: vars.SLACK_WEBHOOK_URL != ''
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "${{ env.STATUS }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "${{ env.STATUS }}\n*Environment:* ${{ needs.determine-environment.outputs.environment }}\n*Region:* ${{ needs.determine-environment.outputs.aws-region }}\n*Triggered by:* ${{ github.actor }}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
